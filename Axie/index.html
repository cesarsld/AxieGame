<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello World</title>
    <script src="/assets/pixi/pixi.min.js"></script>
    <script src="/assets/pixi/pixi-spine.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/assets/game.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" crossorigin="anonymous"></script>
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.7.1/pixi.min.js"></script>-->
</head>
<body>
    <script type="text/javascript">
        var myAxie;
        var axies = {};
        var movement = {
            up : false,
            down : false,
            right : false,
            left : false
        };
        var gameReady = false;
        let type = "WebGL"
        if (!PIXI.utils.isWebGLSupported()) {
            type = "canvas"
        }
        PIXI.utils.sayHello(type)

        //Create a Pixi Application
        let app;
        app = new PIXI.Application(800, 600, { backgroundColor: 0xffffff /*,  transparent: true*/ });
        app.view.id = "canvas";
        app.view.style.height = 480;
        app.view.style.border = "1px solid #d9d9d9";

        //Add the canvas that Pixi automatically created for you to the HTML document
        document.body.appendChild(app.view);

        myAxie = fetchNewAxie();
        //spawnedAxies.add(myAxie);
        //app.start();

        $.get({ url: "https://axieinfinity.com/api/axies/150"}, function (data, status, xhr) {
            if (data.stage < 3) {
                alert("This axie is either a larva or an egg.")
                return;
            }
            let imageName = "150" + ".png";
            //prevent using cache...AI servers have wonky CORS config.
            atlasURL = data["figure"]["atlas"];
            imageURL = data["figure"]["images"][imageName];
            modelURL = data["figure"]["model"];
            let breakCache = "?" + escape(new Date());
            //atlasURL += breakCache;
            //imageURL += breakCache;
            //modelURL += breakCache;

            PIXI.loader.reset();
            PIXI.loader
                .add('axie_atlas', atlasURL)
                .add('axie_png', imageURL)
                .load(function (loader, resources) {
                //cache false to circumvent server's cors caching. server should use vary: origin ? or access-control-allow-origin: *
                $.get({ url: modelURL}, function (rawSkeletonData) {
                    const rawAtlasData = resources['axie_atlas'].data; //your atlas file
                    const spineAtlas = new PIXI.spine.core.TextureAtlas(rawAtlasData, function (line, callback) {
                        //use hash name instead of name from file
                        callback(PIXI.BaseTexture.from('axie_png'));
                    });
                    const spineAtlasLoader = new PIXI.spine.core.AtlasAttachmentLoader(spineAtlas);
                    const spineJsonParser = new PIXI.spine.core.SkeletonJson(spineAtlasLoader);
                    spineData = spineJsonParser.readSkeletonData(rawSkeletonData);
                    myAxie = new PIXI.spine.Spine(spineData);
                    //mirror image myAxie
                    //myAxie.scale.x = -1;
                    myAxie.scale.set(0.25, 0.25);
                    myAxie.position.set(400, 300);
                    myAxie.pivot.set(-myAxie.width * myAxie.scale.x * 0.75, -myAxie.height * myAxie.scale.y * 2);
                    myAxie.stateData.setMix("walking", "appearing", 0.2);
                    myAxie.stateData.setMix("appearing", "walking", 0.2);
                    myAxie.stateData.setMix("bite", "walking", 0.2);
                    myAxie.stateData.setMix("walking", "bite", 0.2);
                    if (myAxie.state.hasAnimation('idle')) {
                        myAxie.state.setAnimation(0, 'idle', true);
                    } else if (myAxie.state.hasAnimation('walking')) {
                        myAxie.state.setAnimation(0, 'walking', true);
                    }
                    myAxie.state.addListener({
                        start: function (entry) {
                            //console.log('animation is set at ' + entry.trackIndex);
                            myAxie.activeAnim = true;
                        }
                    })
                    myAxie.state.addListener({
                        complete: function (entry) {
                            //console.log('animation ended at ' + entry.trackIndex);
                            myAxie.activeAnim = false;
                        }
                    })
                    myAxie.alpha = 1;
                    var _sprite = new PIXI.Graphics();
                    _sprite.beginFill(0xFF0000);
                    _sprite.drawRect(0, 0, 100, 100);
                    _sprite.position.set(400, 300);
                    app.stage.removeChildren();
                    app.stage.addChild(myAxie);
                    app.stage.addChild(_sprite);
                    PIXI.spine.Spine.globalAutoUpdate = true;
                    //var bounds = myAxie.getBounds();
                    //myAxie.position.set(bounds.x + (bounds.width), bounds.y + (bounds.height));
                    //myAxie.pivot.set(bounds.width / 2 / myAxie.scale.x, bounds.height / 2 / myAxie.scale.y);
                    app.start();
                    gameReady = true;
                });
            });
        });
        document.addEventListener('keydown', (event) => {
            const keyName = event.key;
            if (keyName == 'b') {
                if (!myAxie.activeAnim) {
                    myAxie.state.setAnimation(0, 'bite', false);
                    myAxie.state.addAnimation(0, 'walking', true, 0);
                }
            }
            else if (keyName == 'ArrowRight') {
                myAxie.rotation += Math.PI / 37;
                console.log('rotation = ' + myAxie.rotation);
            }
            else if (keyName == 'ArrowLeft') {
                myAxie.rotation -= Math.PI / 37;
            }
            switch (event.keyCode) {
                case 65: // A
                movement.left = true;
                break;
                case 87: // W
                movement.up = true;
                break;
                case 68: // D
                movement.right = true;
                break;
                case 83: // S
                movement.down = true;
                break;
            }
        });
        document.addEventListener('keyup', (event) => {
            switch (event.keyCode) {
                case 65: // A
                //myAxie.position.y += 10;
                movement.left = false;
                break;
                case 87: // W
                movement.up = false;
                break;
                case 68: // D
                movement.right = false;
                break;
                case 83: // S
                movement.down = false;
                break;
            }
        });

function fetchNewAxie()
{
    $.get({ url: "https://axieinfinity.com/api/axies/150"}, function (data, status, xhr) {
            if (data.stage < 3) {
                alert("This axie is either a larva or an egg.")
                return;
            }
            let imageName = "150" + ".png";
            //prevent using cache...AI servers have wonky CORS config.
            atlasURL = data["figure"]["atlas"];
            imageURL = data["figure"]["images"][imageName];
            modelURL = data["figure"]["model"];
            let breakCache = "?" + escape(new Date());
            //atlasURL += breakCache;
            //imageURL += breakCache;
            //modelURL += breakCache;

            //PIXI.loader.reset();
            PIXI.loader
                .add('axie_atlas', atlasURL)
                .add('axie_png', imageURL)
                .load(function (loader, resources) {
                //cache false to circumvent server's cors caching. server should use vary: origin ? or access-control-allow-origin: *
                $.get({ url: modelURL}, function (rawSkeletonData) {
                    const rawAtlasData = resources['axie_atlas'].data; //your atlas file
                    const spineAtlas = new PIXI.spine.core.TextureAtlas(rawAtlasData, function (line, callback) {
                        //use hash name instead of name from file
                        callback(PIXI.BaseTexture.from('axie_png'));
                    });
                    const spineAtlasLoader = new PIXI.spine.core.AtlasAttachmentLoader(spineAtlas);
                    const spineJsonParser = new PIXI.spine.core.SkeletonJson(spineAtlasLoader);
                    var spineData = spineJsonParser.readSkeletonData(rawSkeletonData);
                    var newAxie = new PIXI.spine.Spine(spineData);
                    //mirror image myAxie
                    //myAxie.scale.x = -1;
                    newAxie.scale.set(0.25, 0.25);
                    newAxie.position.set(400, 300);
                    newAxie.pivot.set(-newAxie.width * newAxie.scale.x * 0.75, -newAxie.height * newAxie.scale.y * 2);
                    newAxie.stateData.setMix("walking", "appearing", 0.2);
                    newAxie.stateData.setMix("appearing", "walking", 0.2);
                    newAxie.stateData.setMix("bite", "walking", 0.2);
                    newAxie.stateData.setMix("walking", "bite", 0.2);
                    if (newAxie.state.hasAnimation('idle')) {
                        newAxie.state.setAnimation(0, 'idle', true);
                    } else if (newAxie.state.hasAnimation('walking')) {
                        newAxie.state.setAnimation(0, 'walking', true);
                    }
                    newAxie.state.addListener({
                        start: function (entry) {
                            //console.log('animation is set at ' + entry.trackIndex);
                            newAxie.activeAnim = true;
                        }
                    })
                    newAxie.state.addListener({
                        complete: function (entry) {
                            //console.log('animation ended at ' + entry.trackIndex);
                            newAxie.activeAnim = false;
                        }
                    })
                    newAxie.alpha = 1;
                    //app.stage.removeChildren();
                    app.stage.addChild(newAxie);
                    if (!gameReady) setInterval(function(){updateAxieMovement();}, 1000/60 );
                    gameReady = true;
                    myAxie = newAxie;
                    PIXI.spine.Spine.globalAutoUpdate = true;
                    //return newAxie;
                    app.start();
                });
            });
        });

}

    </script>
</body>
</html>